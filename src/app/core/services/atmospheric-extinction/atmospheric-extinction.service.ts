import { Injectable } from '@angular/core';

@Injectable({
  providedIn: 'root'
})
export class AtmosphericExtinctionService {
  // Red light Extinction Coefficients:
  private Rxc = [
    // Natural Cubic Spline Interpolation Coefficients per Zenith Angle (ZA) interval:
    // ZA1   ZA2   x^3                     x^2                     x^1                     x^0
    [  0.0, 10.0,  5.4044905795245010e-7,  4.5462371796453206e-58, 4.5955094204754990e-5,  1.0 ],
    [ 10.0, 20.0,  2.9775471023774956e-7,  7.2808304314410150e-6, -2.6853210109655157e-5,  1.0002426943477147 ],
    [ 20.0, 30.0, -7.3146789890344840e-7,  6.9034186979912890e-5, -1.2619203410790928e-3,  1.0084764752208444 ],
    [ 30.0, 35.0,  3.1528827572246840e-6, -2.8055737207161903e-4,  9.2258264304668650e-3,  9.035990075053847e-1 ],
    [ 35.0, 40.0, -1.0452442175644348e-6,  1.6024596028123845e-4, -6.2022902018831465e-3,  1.083593701549468 ],
    [ 40.0, 45.0,  1.0280941130330547e-6, -8.8554639390460290e-5,  3.7497337849848027e-3,  9.509000483912289e-1 ],
    [ 45.0, 50.0,  4.9328677654322160e-6, -6.1569908246434700e-4,  2.7471233723309710e-2,  5.950775493163553e-1 ],
    [ 50.0, 55.0, -4.7595651747619180e-6,  8.3816585856477310e-4, -4.5222013328146300e-2,  1.8066316668406222 ],
    [ 55.0, 60.0,  1.4105392933615458e-5, -2.2745522293174940e-3,  1.2597748150537838e-1, -1.3320257384406637 ],
    [ 60.0, 65.0, -3.6620065596999110e-6,  9.2357967947927240e-4, -6.5910433022427590e-2,  2.5057325521154556 ],
    [ 65.0, 70.0,  6.4542633305184200e-5, -1.2376325094173126e-2,  7.9858337726497830e-1, -1.622496667077834e1 ],
    [ 70.0, 75.0, -7.8508526661036830e-5,  1.7664418498733290e-2, -1.3042686742384708,     3.284158119763547e1 ]
  ];
  // Green light Extinction Coefficients:
  private Gxc = [
    // Natural Cubic Spline Interpolation Coefficients per Zenith Angle (ZA) interval:
    // ZA1   ZA2   x^3                     x^2                     x^1                     x^0
    [  0.0, 10.0,  1.2445591495795023e-6,  1.1690206294655140e-57, 7.5544085042049760e-5,  1.0  ],
    [ 10.0, 20.0, -2.2279574789751180e-7,  4.4020646924310420e-5, -3.6466238420105446e-4,  1.001467354897477  ],
    [ 20.0, 30.0,  6.4662384201054490e-7, -8.1445284701729740e-6,  6.7864112368861350e-4,  9.945119981782126e-1  ],
    [ 30.0, 35.0,  5.5552498157654200e-7,  5.4368968887286390e-8,  4.3267420051680566e-4,  9.969716674099306e-1  ],
    [ 35.0, 40.0,  1.2017281678068652e-6, -6.7796965585296660e-5,  2.8074709099132436e-3,  9.692657058003056e-1 ],
    [ 40.0, 45.0,  2.6375623471959970e-6, -2.4009706711199250e-4,  9.6994749709810760e-3,  8.773723183194011e-1 ],
    [ 45.0, 50.0,  4.2480224434091470e-6, -4.5750918010076760e-4,  1.9483020055475957e-2,  7.306191420519779e-1  ],
    [ 50.0, 55.0,  4.3703478791674180e-6, -4.7585799546450834e-4,  2.0400460823662994e-2,  7.15328462582194e-1 ],
    [ 55.0, 60.0,  1.8270586039921184e-5, -2.7693972919888795e-3,  1.4654512213250340e-1, -1.5973236614132136  ],
    [ 60.0, 65.0, -5.4526920388521480e-6,  1.5007927621903200e-3, -1.0966628111824855e-1,  3.5269044036018258  ],
    [ 65.0, 70.0,  1.7154018211548740e-4, -3.3012817697905890e-2,  2.1337183987880053,    -4.5079763661033674e1 ],
    [ 70.0, 75.0, -2.0070803642309750e-4,  4.5159308195196930e-2, -3.3383304137291927,     8.260137529770094e1 ]
  ];
  // Blue light Extinction Coefficients:
  private Bxc = [
    // Natural Cubic Spline Interpolation Coefficients per Zenith Angle (ZA) interval:
    // ZA1   ZA2   x^3                     x^2                      x^1                     x^0
    [  0.0, 10.0,  1.5944732788694797e-6,  2.00651823727832540e-57, 1.4055267211305204e-4,  1.0 ],
    [ 10.0, 20.0,  2.7633605652601580e-8,  4.70051901965063460e-5, -3.2949922985201140e-4,  1.001566839673217 ],
    [ 20.0, 30.0,  2.9499229852011400e-7,  3.09636686244556000e-5, -8.6687984109965120e-6,  9.994279701302767e-1  ],
    [ 30.0, 35.0,  2.6721838993209414e-6, -1.82983575447618807e-4,  6.4097485237512375e-3,  9.352437969086544e-1  ],
    [ 35.0, 40.0,  3.6338903068889500e-6, -2.83962748242259800e-4,  9.9440195715636700e-3,  8.940106346841761e-1 ],
    [ 40.0, 45.0, -1.2077451268767415e-6,  2.97033503809623240e-4, -1.3295830510511650e-2,  1.2038753024451803 ],
    [ 45.0, 50.0,  9.1970902006180170e-6, -1.10761926540216900e-3,  4.9913544104019000e-2,  2.5573468322722054e-1  ],
    [ 50.0, 55.0,  4.4193843244046775e-6, -3.90963383970168250e-4,  1.4080750032418961e-2,  8.529479177538879e-1 ],
    [ 55.0, 60.0,  3.7125372501763275e-5, -5.78745143323433700e-3,  3.1088759274194820e-1, -4.588510865254149 ],
    [ 60.0, 65.0, -1.6920874331457777e-5,  3.94087299674545240e-3, -2.7281187305683910e-1,  7.085478450721599 ],
    [ 65.0, 70.0,  3.0255812482406783e-4, -5.83575318385820400e-2,  3.776584441239448,     -8.065144169236463e1 ],
    [ 70.0, 75.0, -3.4531162496481357e-4,  7.76951156170830500e-2, -5.747100880657109,      1.415678824852217e2 ]
  ];

  constructor() { }

  private calculateExtinction(altitudeDegrees: number, filter: string): number {
    // Algorithm:
    // 1. Given argument zenithAngle (ZA) lookup interval (V) such that ZA1 <= ZA < ZA2
    // 2. Calculate ZA*(ZA*(ZA*V[2]+V[3])+V[4])+V[5]
    let cubicSpline = [];
    if (filter === "R") {
      cubicSpline = this.Rxc;
    }
    else if (filter === "G") {
      cubicSpline = this.Gxc;
    }
    else if (filter === "B") {
      cubicSpline = this.Bxc;
    }
    let extinction = Number.NaN;
    if (cubicSpline.length > 0) {
      const length = cubicSpline.length;
      const zenithAngle = 90 - altitudeDegrees;
      for (let index = 0; index < length; index++) {
        const interval = cubicSpline[index];
        if (interval[0] <= zenithAngle && zenithAngle < interval[1]) {
          extinction = zenithAngle*(zenithAngle*(zenithAngle*interval[2]+interval[3])+interval[4])+interval[5];
          break;
        }
      }
    }
    return extinction;
  }

  redExtinction(altitudeDegrees: number): number {
    return this.calculateExtinction(altitudeDegrees, "R");
  }

  greenExtinction(altitudeDegrees: number): number {
    return this.calculateExtinction(altitudeDegrees, "G");
  }

  blueExtinction(altitudeDegrees: number): number {
    return this.calculateExtinction(altitudeDegrees, "B");
  }

}
